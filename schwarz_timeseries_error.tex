%% Copernicus Publications Manuscript Preparation Template for LaTeX Submissions
%% ---------------------------------
%% This template should be used for copernicus.cls
%% The class file and some style files are bundled in the Copernicus Latex Package, which can be downloaded from the different journal webpages.
%% For further assistance please contact Copernicus Publications at: production@copernicus.org
%% https://publications.copernicus.org/for_authors/manuscript_preparation.html


%% Please use the following documentclass and journal abbreviations for preprints and final revised papers.

%% 2-column papers and preprints
\documentclass[journal abbreviation, manuscript]{copernicus}



%% Journal abbreviations (please use the same for preprints and final revised papers)


% Advances in Geosciences (adgeo)
% Advances in Radio Science (ars)
% Advances in Science and Research (asr)
% Advances in Statistical Climatology, Meteorology and Oceanography (ascmo)
% Aerosol Research (ar)
% Annales Geophysicae (angeo)
% Archives Animal Breeding (aab)
% Atmospheric Chemistry and Physics (acp)
% Atmospheric Measurement Techniques (amt)
% Biogeosciences (bg)
% Climate of the Past (cp)
% DEUQUA Special Publications (deuquasp)
% Earth Surface Dynamics (esurf)
% Earth System Dynamics (esd)
% Earth System Science Data (essd)
% E&G Quaternary Science Journal (egqsj)
% EGUsphere (egusphere) | This is only for EGUsphere preprints submitted without relation to an EGU journal.
% European Journal of Mineralogy (ejm)
% Geochronology (gchron)
% Geographica Helvetica (gh)
% Geoscience Communication (gc)
% Geoscientific Instrumentation, Methods and Data Systems (gi)
% Geoscientific Model Development (gmd)
% History of Geo- and Space Sciences (hgss)
% Hydrology and Earth System Sciences (hess)
% Journal of Bone and Joint Infection (jbji)
% Journal of Environmentally Compatible Air Transport System (jecats)
% Journal of Micropalaeontology (jm)
% Journal of Sensors and Sensor Systems (jsss)
% Magnetic Resonance (mr)
% Mechanical Sciences (ms)
% Natural Hazards and Earth System Sciences (nhess)
% Nonlinear Processes in Geophysics (npg)
% Ocean Science (os)
% Polarforschung - Journal of the German Society for Polar Research (polf)
% Proceedings of the International Association of Hydrological Sciences (piahs)
% Proceedings of the International Ocean Drilling Programme (piodp)
% Safety of Nuclear Waste Disposal (sand)
% Scientific Drilling (sd)
% SOIL (soil)
% Solid Earth (se)
% State of the Planet (sp)
% The Cryosphere (tc)
% Weather and Climate Dynamics (wcd)
% Web Ecology (we)
% Wind Energy Science (wes)


%% \usepackage commands included in the copernicus.cls:
%\usepackage[german, english]{babel}
%\usepackage{tabularx}
%\usepackage{cancel}
%\usepackage{multirow}
%\usepackage{supertabular}
%\usepackage{algorithmic}
%\usepackage{algorithm}
%\usepackage{amsthm}
%\usepackage{float}
%\usepackage{subfig}
%\usepackage{rotating}


\begin{document}

%\title{Time-series uncertainty with Wiener fouling and drift}
\title{Uncertainty of time-series measurements subject to Wiener fouling and calibration-drift}



% \Author[affil]{given_name}{surname}

\Author[1]{Gregory}{Schwarz}
\Author[1][thodson@usgs.gov]{Timothy O.}{Hodson} %% correspondence author

\affil[1]{U.S. Geological Survey Water Resources Mission Area}

%% The [] brackets identify the author with the corresponding affiliation. 1, 2, 3, etc. should be inserted.

%% If an author is deceased, please add \deceased[$Deceased date if applicable$]{$Author number$} (e.g. \deceased[13 November 2015]{2}) at the end of the affiliations. The author number depends on the placement of the author in the author list, e.g. the third author has number 3.


%% If authors contributed equally, please add \equalcontrib{$Author numbers$} (e.g. \equalcontrib{1,3}) at the end of the affiliations. The author number depends on the placement of the author in the author list, e.g. the third author has number 3.




\runningtitle{Wiener Error}

\runningauthor{Schwarz and Hodson}





\received{}
\pubdiscuss{} %% only important for two-stage journals
\revised{}
\accepted{}
\published{}

%% These dates will be inserted by Copernicus Publications during the typesetting process.


\firstpage{1}

\maketitle



\begin{abstract}
Test
\end{abstract}


\copyrightstatement{TEXT} %% This section is optional and can be used for copyright transfers.


\introduction  %% \introduction[modified heading if necessary]
%
TEXT

%TODO transition here
In a measuring device 
In practice, deterimination of these errors is used to correct the raw measurements
Later on, these 

% USGS operates a network of several thousands of such devices
% so a flexible approach
% Introduce Wagner here as the standard USGS methodology for correcting
% time-series measurements for drift and fouling,
% which is why we reference instead of more standard texts on measurement error.

\subsection{Preliminaries}
%
Let $x$ be the true value of some variable,
$y$ be a measurement of $x$,
such that the absolute error $e$ is the difference between the two,
%
\begin{equation}
    e = y - x
    \text{,}
\end{equation}
%
or error may be more accurately represented in relative terms,
%
\begin{equation}
    \%e = 100 \times \frac{y - x}{y}
    \text{,}
\end{equation}
%
given as a percentage of the measured value.
Either form may used to estimate an uncertainty interval,
depending on the properties of the measurement device.

Furthermore, we assume each measurement comprises three types of error:
fouling $e_f$,
calibration drift $e_d$,
and the innate precision of the measuring device $e_p$,
which sum to the total,
%
\begin{equation}
    e = e_f + e_d + e_p % note e = -c (correction)
    \text{.}
\end{equation}
%
Fouling results from some physical, chemical, or biological buildup 
that interferes with the measurement.
The magnitude of fouling is determined by taking check
measurements before and after cleaning the measurement device.
Under steady-state conditions, the fouling error is given by
%
\begin{equation}
    e_f = y_b - y_a
\end{equation}
%
where $y_a$ is the measurement after cleaning,
and $y_b$ is the measurement before cleaning.
Otherwise, the error must account for any changes
in the environment during the cleaning,
%
\begin{equation}
    e_f = (y_b - y_a) - (z_b - z_a)
    \qquad \text{or} \qquad
    \%e_f = 100 \times \frac{(y_b - y_a) - (z_b - z_a)}{y_b}
    \label{eq:fouling_error}
\end{equation}
%
where $z_a$ and $z_b$ are measurements from a reference device in the same
environment \citep[][but note their convention, $e = x - y$,
flips the sign in several equations]{Wagner_2006}.


Calibration drift results from any electronic (or mechanical) drift
in accuracy since the measurement device was last calibrated;
in other words, any residual bias after cleaning the device.
The magnitude of calibration-drift is determined by comparing a clean measurement
against a known standard $z_s$,
%
\begin{equation}
    e_d = y_s - z_s
    \qquad \text{or} \qquad
    \%e_{d} = 100 \times \frac{y_s - z_s}{y_s}
    \text{.}
    \label{eq:drift_error}
\end{equation}
%
where $z_s$ is the standard value,
and $y_s$ is its measurement of $z_s$ \citep{Wagner_2006}.

Lastly, precision error $e_p$ results from the inherent inaccuracy of any measurement device.
% not affected by fouling or drift.
In practice, precision is determined under controlled laboratory conditions
and is approximated with a normal distribution,
%
\begin{equation}
    e_p \sim \mathcal{N}\left(0, \sigma^2_p \right)
    \qquad \text{or} \qquad
    \%e_{p} \sim y \frac{\sigma_{\%p}}{100} \mathcal{N}\left(0 ,\, 1 \right)
    %\%e_{p} \sim \mathcal{N}\left(0, \left( \frac{\%\sigma_p}{100} y \right)^2 \right)
    \text{.}
    \label{eq:precision_error}
\end{equation}
%
In many cases, precision is determined by the manufacturer
and reported among the device specifications
(as "accuracy"),
and noting that the reported accuracy usually corresponds to the $2\sigma$ or
95\% confidence interval.
%$e_p \sim \mathcal{N}\left(0, 0.05^2 \right)$
Though not a requirement,
we often assume fouling and drift errors have the same
form---absolute or relative---as the precision.

% TODO define \sigma_s
In normal operation,
the device is calibrated against a standard of known precision $\sigma_s$,
which affects the accuracy of the calibration.
We often ignore $\sigma_s$,
unless it is large relative to the device precision,
in which case it should be included in the variance,
\begin{equation}
    \sigma^2_{\tilde{p}} = \sigma^2_{p} + \sigma^2_{s}
    \text{.}
\end{equation}

\subsection{The Measurement Procedure}

A clean and calibrated device is deployed into the environment to measure some variable of interest.
As time passes, fouling and calibration-drift errors accumulate,
which bias the raw measurements.
To correct for that bias,
the fouling and calibration are periodically checked.
Any check might determine one or both errors,
and may or may not involve cleaning or recalibrating the device.
After the check,
the raw time series measurements should be corrected to account for any fouling and calibration error,
typically, by assuming the error grows at a constant rate between checks \citep{Wagner_2006}.
Reality can be more complicated, but for simplicity,
we extend this same assumption as a basis for modeling the uncertainty.

\subsection{Wiener-Process Error Model}

We will assume that the drift and fouling errors
follow a Wiener process with an optional drift term $\mu$.
%not to be confused with the calibration drift.
Formally, a Wiener process is a continuous-time stochastic process
for which the increments are independent and normally distributed,
with variance proportional to the time elapsed,
and a drift term representing the average rate of change over time
(with $\mu=0$ for a classical Wiener process).
This drift term is important for devices exhibiting a systematic bias over time,
such as due to the gradual degradation of some consumable element.

Let $E_t$ be a random variable representing the error at time $t$,
and $e_t$ be its realization (observed value).


Suppose we observe the error at times $0 = t_0 < t_1 < t_2 < \cdots < t_K = T$.
To simplify notation, we write $e_k := e_{t_k}$,
such that $E_{t_k} = e_k$ for $k = 0, 1, \ldots, K$.
Thus, $t_k - t_{k-1}$ represents the time elapsed between subsequent observations
$e_{k-1}$ and $e_k$,
and the subscript $k$ serves a place holder for either fouling $f$ or drift $d$ terms,
$k \in \{f, d\}$.

First, consider the case after observing the error at time $t_{k-1}$,
but before observing the error at time $t_k$
%($t \in [t_{k-1}, t_k)$).
% ($t_{k-1} \le t < t_k$).
We refer to this as an open interval, typical of real-time uncertainty estimation.
In contrast, a closed interval is bracketed by observations at both $t_{k-1}$ and $t_k$,
and the conditional mean and variance are revised retrospectively.

For an open interval,
the conditional distribution of the Wiener-process error is
%
\begin{equation}
    p(e_t \mid E_{k-1} = e_{k-1})
    =
    \mathcal{N}(m^o(t),\, v^o(t))
    \text{,} \qquad
    t > t_{k-1}
    %\mathcal{N}(\delta_{k-1}  e_{k-1} + \mu t ,\, \sigma^2 t)
\end{equation}
%
%\begin{equation}
%    E_{t} \mid E_0 = e_0 \sim \mathcal{N}(e_0 + \mu t ,\; \sigma^2 t) \text{,}
%    \label{eq:wiener_process}
%\end{equation}
%
with conditional mean and variance given by
\begin{align}
    m^o(t) &:=
        \mathbb{E}\left[E_t \mid E_{k-1} = e_{k-1} \right]
        = \delta_{k-1} e_{k-1} + \mu (t - t_{k-1})
        \qquad \text{and}
        \label{eq:wiener_mean}\\
    v^o(t) &:=
        \operatorname{Var}\left[E_t \mid E_{k-1} = e_{k-1} \right]
        = \sigma^2 (t - t_{k-1})
        \label{eq:wiener_variance}
    \text{.}
\end{align}
%
where $\delta_{k-1}$ indicates whether the error process has been reset
due to cleaning or recalibration,
\begin{equation}
    \delta_{k-1} =
    \begin{cases}
        0, & \text{reset at } t_{k-1} \\
        1, & \text{otherwise}
    \end{cases}
    \text{,}
\end{equation}
$e_{k-1}$ is the error at time $t_{k-1}$,
%$\mathcal{N}$ is the normal distribution
%specified by its mean and variance,
$\mu$ is the drift rate (mean change per unit time),
$\sigma^2$ is the instantaneous variance rate (variance per unit time).
Thus for any $t \ge 0$,
it follows that the conditional mean and variance are
%
%
%
Later on, upon observing the error at time $t_k$,
the conditional distribution of $E_t$ is updated.
A Wiener process conditioned to start and end at specified values
is known as a Brownian bridge.
To simplify notation, 
let $\lambda(t)$ be the linear interpolation weight,
%
\begin{equation}
    \lambda_k(t) = \frac{t - t_{k-1}}{t_k - t_{k-1}}
    \text{,} \qquad
    k \in \{f, d\}
\end{equation}
%
such that $\lambda_f(t)$ denotes the fouling weight
for the interval $t \in \left[t_{f-1}, t_f \right]$.
Then the conditional distribution of the bridge at time
$t$ is
%
\begin{equation}
    p(e_t \mid E_{t_{k-1}} = e_{k-1},\, E_{t_k} = e_k)
    =
    \mathcal{N} \left(
        m^c(t), v^c(t)
        %\delta_{k-1} \left( 1 - \lambda(t) \right)e_{k-1}
        %+ 
        %\lambda(t) e_k,\;
        %\sigma^2 (1 - \lambda(t)) \lambda(t) (t_k - t_{k-1})
    \right)
    \text{,} \qquad
    t \in \left[t_{k-1},\, t_k \right]
\end{equation}
%
with conditional mean and variance given by
%
\begin{align}
    m^c(t) &:=
        \mathbb{E}\left[ E_t \mid E_{t_{k-1}} = e_{k-1} ,\, E_{t_k} = e_k \right]
        =
        \delta_{k-1} \left( 1 - \lambda(t) \right) e_{k-1} + \lambda(t) e_k
        \qquad \text{and}
        \label{eq:bridge_mean} \\
    v^c(t) &:=
    \operatorname{Var} \left[ E_t \mid E_{t_{k-1}} = e_{k-1} ,\, E_{t_k} = e_k \right]
        = \sigma^2 \frac{(t - t_{k-1})(t_{k} - t)}{t_{k} - t_{k-1}} 
        % = \sigma^2 (1 - \lambda_k(t)) (t - t_{k-1})
        \label{eq:bridge_variance}
    \text{,}
\end{align}

%
Let $\lambda^+_k(t)$ be the linear interpolation weight,
extended by
%
\begin{equation}
    \lambda^+_k(y) :=
    \begin{cases}
        1, & t < t_{1} \\
        \frac{t - t_{k-1}}{t_k - t_{k-1}}, & t \in [t_{k-1}, t_k] \\
        0, & t > t_{K}
    \end{cases}
    \text{,}
\end{equation}
%
such that $\lambda^+_k(t) = 1$ or $0$ when extrapolating
below or above the standard range, respectively.
Also let $\phi^+_k(t)$ define the bridge factor, extended by
\begin{equation}
    \phi^+_k(t) :=
    \begin{cases}
        (t_{1} - t), & t < t_{1} \\
        \frac{(t - t_{k-1})(t_{k} - t)}{(t_{k} - t_{k-1})},
        & t \in [t_{k-1}, t_{k}] \\
        (t - t_{K}), & t > t_{K} 
    \end{cases}
    \text{.}
\end{equation}
By substituting these definitions into the equations for the mean and covariance,
the open and closed forms become equivalent,
\begin{align}
    m(t) &= \delta_{k-1} \left( 1 - \lambda^+_k(t) \right)e_{k-1} + \lambda^+_k(t) e_k
    \qquad \text{and} \qquad \\
    v(t) &= \sigma^2 \phi^+_k(t)
    \text{,}
\end{align}
thereby eliminating the need for superscripts ($m^o$, $m^c$, etc.).

\subsection{Precision Error Model}

% TODO revise to calibration error model
Recall that the precision of the measurement device $\sigma_{p}$ is assumed to be
constant over time (Equation~\ref{eq:precision_error}).
Thus, for normal errors, the conditional distribution is
%
\begin{equation}
    p(e_t \mid E_{t_{k-1}} = e_{k-1}) = \mathcal{N}
        \left(m^o(t),\,v^o(t)\right)
    \text{,}
\end{equation}
%
with conditional mean and variance given by
%
\begin{align}
    m^o(t)
        &:= \mathbb{E}\left[E_t \mid E_{t_{k-1}} = e_{k-1} \right]
        = 0
        \qquad \text{and} \\
    v^o(t)
        &:= \operatorname{Var}\left[E_t \mid E_{t_{k-1}} = e_{k-1} \right]
        = \sigma^2_{p}
        \text{.}
        \label{eq:precision_variance_open}
\end{align}
%
However, the conditional distribution for the closed interval is complicated
by the indirect effect of calibration.
In this case, the conditional variance is
%
% TODO XXX note the indirect effect of calibration
\begin{align}
    v^c(t)
        &:= \operatorname{Var}\left[E_t \mid E_{t_{k-1}} = e_{k-1} ,\, E_{t_k} = e_k \right]
        = \lambda_{d}(t) \chi_{d}(t) \sigma_p^2
        +
        \sigma_p^2
        \text{,}
        \label{eq:precision_variance_closed}
\end{align}
where $\chi_{d}$ is an indicator function
equal to 1 if $t \neq t_{d}$ and 0 otherwise,
\begin{equation}
\chi_{d}(t) =
\begin{cases}
    1, & t \neq t_{d} \\
    0, & t = t_{d}
\end{cases}
\label{eq:chi_function}
\text{,}
\end{equation}
which modulates the indirect effect of calibration-drift on the precision error.

\subsection{Multi-point Correction}

Sometimes multiple standards are used to calibrate the device.
For example, a pH meter might be calibrated against standards at pH 4, 7, and 10.
In that case, the expected drift-correction for a measurement is 
a linear interpolation between
the corrections for the two nearest standards \citep{Wagner_2006}.

Given standard values $z_s$ for $s = 1, 2, \ldots, S$,
the conditional mean is a bilinear interpolation between four points,
$e_{k-1,s-1}$, $e_{k-1,s}$, $e_{k,s-1}$, and $e_{k,s}$,
denote as the set
$\{e_{i,j}\}$ where $i\in\{k-1,k\}$ and $j\in\{s-1,s\}$.
%
% bilinear interpolation between four points
% e{k,s} and so on
% in terms of \lambda_k(t) \lambda_s(x)
\begin{align}
    m(t, y)
    &:=
    \mathbb{E}\left[
        E_{t,y}\,\mid\,
        \{\,E_{t_i,y_j}=e_{i,j}\,\}_{\,i\in\{k-1,k\},\, j\in\{s-1,s\}}
        \right] \notag \\
    &=
    (1-\lambda^+_k(t),\;\lambda^+_k(t))
    \begin{bmatrix}
        \delta_{k-1} e_{k-1,s-1} & \delta_{k-1} e_{k-1,s} \\
        e_{k,s-1}   & e_{k,s}
    \end{bmatrix}
    \begin{bmatrix}
        1-\lambda^+_s(y) \\
        \lambda^+_s(y)
    \end{bmatrix}.
\end{align}
Expanding the right-hand side yields
\begin{align}
    m(t,y)
    &=
    (1 - \lambda_k(t))(1 - \lambda_s(y)) \delta_{k-1} e_{k-1,s-1} \notag \\
    &\quad
    + (1 - \lambda_k(t)) \lambda_s(y) \delta_{k-1} e_{k-1,s} \notag \\
    &\quad
    + \lambda_k(t)(1 - \lambda_s(y)) e_{k,s-1} \notag \\
    &\quad
    + \lambda_k(t) \lambda_s(y) e_{k,s}
    \text{,}
\end{align}
which satisfies the conditions for the four corner points,
\begin{align}
    m(t_{k-1}, y_{s-1}) &=  \delta_{k-1}e_{k-1,s-1} \text{,} \notag \\
    m(t_{k-1}, y_{s})   &=  \delta_{k-1}e_{k-1,s} \text{,} \notag \\
    m(t_{k}, y_{s-1})   &=  e_{k,s-1} \text{,} \notag \\
    m(t_{k}, y_{s})     &=  e_{k,s} \text{.}
\end{align}
%
The conditional variance is given by
%
\begin{align}
    v(t, y)
    &:=
    \operatorname{Var}\left[
        E_{t,y}\,\mid\,
        \{\,E_{t_i,y_j}=e_{i,j}\,\}_{\,i\in\{k-1,k\},\, j\in\{s-1,s\}}
        \right] \\
    &=
    \left[
        \left(1 - \lambda^+_s(y)\right)^2 \sigma^2_{s-1}
        +
        \lambda^+_s(y)^2 \sigma^2_{s}
    \right]
    \underbrace{
        \frac{\left(t - t_{k-1}\right) \left(t_{k} - t\right)}
        {\left(t_{k} - t_{k-1}\right)}
    }_{\text{time-variance factor}} \\
    &=
    \left[
    \left(1 - \lambda^+_s(y)\right)^2 \sigma^2_{s-1}
    +
    \lambda^+_s(y)^2 \sigma^2_{s}
    \right]
    \phi^+_k(t)
\end{align}
% TODO need to verify closed-interval variance
Here, we might reasonably assume
\begin{equation}
    v(t, y) = \sigma \phi^+_k(t)
\end{equation}

\subsection{SCRATCH}
the conditional mean of the Wiener-process error at time $t$ and reading $y$ is
%
\begin{align}
    m^o(t, y)
    &:=
    \mathbb{E}\left[
        E_{t,y}\,\mid\,
        E_{k-1,s-1} = e_{k-1,s-1}, \,
        E_{k-1,s} = e_{k-1,s}, \,
        \right] \notag \\
    &=
    (1-\lambda_s(y))
    \left[
        \delta_{k-1} e_{k-1,s-1} + \mu_{s-1}(t - t_{k-1})
    \right]
    +
    \lambda_s(y)
    \left[
         \delta_{k-1} e_{k-1,s} + \mu_{s} (t - t_{k-1})
    \right]
\end{align}
Note this is a linear interpolation between the two standards.
% and also applies to extraplolation
%


\subsection{RESUME HERE}
In practice, imputation
Say you observe $e_{k, s-1}$ and $e_{k, s+1}$ at time $t_k$,
but not $e_{k, s}$.
%Then the closed-interval conditional mean is
\begin{equation}
   \hat{e}_{k,s} =
    (1 - \lambda^+_s(y)) e_{k,s-1} + \lambda^+_s(y) e_{k,s+1}
    \text{,}
\end{equation}

and the conditional variance of the imputed error
\begin{align}
    \hat{\sigma}^2_{s}
    &=
    \operatorname{Var}\left[
        E_{t,y} \mid
        E_{k,s-1} = e_{k,s-1}, \,
        E_{k,s+1} = e_{k,s+1}
        \right] \\
    &=
    (1 - \lambda^+_s(y))^2 \sigma^2_{s-1} + \lambda^+_s(y)^2 \sigma^2_{s+1}
\end{align}

Conversly, when $e_{k,s}$ is observed, then
$\hat{\sigma}^2_{c} = \sigma^2_{p} + \sigma^2_{s}$.

\subsection{Combined Error}
% TODO change superscript notations to $o$ and $b$ for bridge
The conditional mean and variance given by the sum of the individual components,
%
\begin{align}
m(t) &=
    m_{f}(t)
    +
    m_{d}(t, y)
    +
    m_{c}(t, y)
    \qquad \text{and}
    \label{eq:total_mean_open} \\
v(t) &=
    v_{f}(t)
    +
    v_{d}(t, y)
    +
    v_{c}(t, y)
    +
    v_{p}(t)
    \text{,}
\end{align}
%
where $f$, $d$, $c$, and $p$ denote the fouling, drift, calibration, and precision, respectively.

TODO FIGURE

\begin{figure*}[t]
%\includegraphics[width=12cm]{FILE NAME}
\caption{TEXT}
\label{fig:}
\end{figure*}
%

\subsection{Corrected Measurement and Confidence Interval}

Let $X_t$ denote the true value at time $t$,
and let $E_t$ denote the measurement error so that $Y_t = X_t + E_t$.
%Define $m(t) := \mathbb{E}[E_t]$ and $v(t) := \operatorname{Var}(E_t)$.
Then the bias-corrected estimate of $X_t$ is
%
\begin{equation}
    x(t) := \mathbb{E}\!\left[X_t \mid Y_t = y_t\right]
        = y_t - m(t)
        \text{,}
\end{equation}
%
with approximate confidence interval
%
\begin{equation}
    \text{CI} = x(t) \pm q_{1-\alpha/2} \sqrt{v(t)}
    \text{, }
\end{equation}
%
where $q_{1-\alpha/2}$ is the $(1-\alpha/2)$ quantile of the standard normal distribution
(e.g., $q_{0.975} = 1.96$ for a 95\% confidence interval).
Alternatively, for percent error $\%E_{t}$, the measured value is
%
\begin{equation}
    Y_t = \frac{X_t}{1 - \%E_{t}/100}
    % removing the 100x from the error simplifies here
\end{equation}
%
Then, on the original scale, the bias-corrected estimate of $X_t$ is
%
\begin{equation}
    x(t) := \mathbb{E}[X_t \mid Y_t = y_t]
        = y_t \left( 1 - \frac{\%m(t)}{100} \right)
        \text{.}
\end{equation}
%
and the confidence interval is
%
\begin{equation}
    \text{CI} = x(t) \pm q_{1-\alpha/2} \, \frac{y_t}{100} \sqrt{\%v(t)}
\text{.}
\end{equation}

\section{Parameter Estimation}

Letting
%
\begin{align}
    r(\mu_k) &:= e_k - \delta_{k-1} e_{k-1} - \mu_k (t - t_{k-1}) \\
    u(\sigma^2_k) &:= \sigma^2_k (t - t_{k-1}) + \sigma^2_p
\end{align}
%
and assuming the residuals are independent and identically distributed (i.i.d),
%
\begin{equation}
    e_k \mid \mu, \sigma^2
    \sim \mathcal{N}(
        \delta_{k-1} e_{k-1} + \mu_k (t_k - t_{k-1}),\;
        \sigma^2_k (t_k - t_{k-1}) + \sigma^2_p
    )
\end{equation}
%
then we can estimate $\mu$ and $\sigma^2_k$ by maximumizing the log-likelihood function,
%
\begin{equation}
    \ell(\mu, \sigma^2)
    =
    %-\frac{K_i}{2} \ln(2 \pi)
    - \frac{1}{2} \sum_{k=1}^{K_i}
    \left[
        \log \left( u(\sigma^2_k) \right)
        +
        \frac{r(\mu_k)^2}{u(\sigma^2_k)}
    \right]
\end{equation}
%
\subsection{Multi-point in matrix form}
Let the calibration error be
%
\begin{equation}
    e_{t,y} = m(t,y) +
\end{equation}
%
%
Let
%
\begin{equation}
    \vec{e} :=
    \begin{bmatrix}
        e_{t_1,y_1} \\
        \vdots \\
        e_{t_N,y_N}
    \end{bmatrix}
    \text{,} \qquad
    \vec{m} :=
    \begin{bmatrix}
        m(t_1,y_1) \\
        \vdots \\
        m(t_N,y_N)
    \end{bmatrix}
    \text{,} \qquad
    \vec{F} :=
    \begin{bmatrix}
        \phi_k(t_1) & \phi_s(t_1) \\
        \vdots & \vdots \\
        \phi_k(t_N) & \phi_s(t_N)
    \end{bmatrix}
    \text{,} \qquad
    \vec{\Sigma}_k :=
    \begin{bmatrix}
        \sigma^2_{t} & \sigma_{tk} \\
        \sigma_{kt} & \sigma^2_{k}
    \end{bmatrix}
\end{equation}
%
\begin{equation}
    \vec{e} \sim \mathcal{N}(\vec{m}, \vec{\Sigma})
\end{equation}
%
with conditional variance given by
%
\begin{equation}
    \vec{\Sigma} =
    \vec{F} \vec{\Sigma}_v \vec{F}^T
    +
    \vec{\sigma}_{\varepsilon} \vec{I}_N
    +
    \vec{\sigma}_{p} \vec{I}_N
\end{equation}

The Gaussian log-likelihood function is
%
\begin{equation}
    \ell(\mu_k, \vec{\Sigma}^2_k, \sigma^2_{\varepsilon})
    =
    -\frac{1}{2}
    \left[
        N \log (2\pi) 
        +
        \log \det( \vec{\Sigma} )
        +
        (\vec{e} - \vec{m})^T \vec{\Sigma}^{-1} (\vec{e} - \vec{m})
    \right]
\end{equation}

Ignoring the covariance term, allows us to avoid the matrix inversion and determinant,
\begin{equation}
    \ell(\mu_k, \sigma^2_k, \sigma^2_{\varepsilon})
    =
    -\frac{N}{2} \log(2\pi)
    -\frac{1}{2} \sum_{i=1}^{N}
    \left[
        \log(u(\sigma^2_k)) + \frac{r(\mu_k)^2}{u(\sigma^2_k)}
    \right]
\end{equation}


\section{Hierarchical Modeling}
% \sigma_ij (site i and bin j )
The hierarchical estimate of the instantaneous variance rate $\sigma^2$ for site $i$ is given by
%
\begin{equation}
    \hat{\sigma}^2_i = X
\end{equation}
%
Invergese gamma distribution prior
%
\begin{equation}
    p(\sigma^2 \mid a ,\; b)
    =
    \frac{b^a}{\Gamma(a)} (\sigma^2)^{-(a+1)}
    \exp\left(-\frac{b}{\sigma^2}\right)
\end{equation}
%
\begin{equation}
    \bar{\sigma}
    \equiv
    \mathbb{E} \left[ \sigma^2 \mid a, b \right]
    = \frac{b}{a - 1}
\end{equation}
%
% TODO define residuals as r and sites as j
\begin{equation}
    \ln L(r \mid a ,\; b)
    =
    \sum_{j \in J}
    \left(
        - \frac{N_j}{2} \ln(2 \pi)
        + a \ln(b)
        + \ln \Gamma \left( \frac{N}{2} + a \right)
        - \left( \frac{N_j}{2} + a \right)
        \ln( \frac{N_j s^2_j}{2} + b)
        - \ln \Gamma(a)
    \right)
\label{eq:hierarchical_likelihood}
\end{equation}

The hierarchical estimate of the instantaneous variance rate $\sigma^2$ for site $j$ is given by
\begin{equation}
    \hat{\sigma}^2_j
    =
    \hat{w}_j s_j^2 + (1 - \hat{w}_j) \bar{\hat{\sigma}}^2
\end{equation}
where
\begin{equation}
    \hat{w}_j
    =
    \frac{N_j}{N_j + 2 (\hat{a} - 1)}
\end{equation}

\subsection{Maximum Likelihood Estimation}

\subsection{Method of Moments}

\subsection{Simulation Experiments}
TEXT


\conclusions  %% \conclusions[modified heading if necessary]
TEXT

%% The following commands are for the statements about the availability of data sets and/or software code corresponding to the manuscript.
%% It is strongly recommended to make use of these sections in case data sets and/or software code have been part of your research the article is based on.

\codeavailability{TEXT} %% use this section when having only software code available

% \dataavailability{TEXT} %% use this section when having only data sets available
% \codedataavailability{TEXT} %% use this section when having data sets and software code available
% \sampleavailability{TEXT} %% use this section when having geoscientific samples available
% \videosupplement{TEXT} %% use this section when having video supplements available


\appendix
\section{Proofs}    %% Appendix A
\subsection{}

\noappendix       %% use this to mark the end of the appendix section. Otherwise the figures might be numbered incorrectly (e.g. 10 instead of 1).

%% Regarding figures and tables in appendices, the following two options are possible depending on your general handling of figures and tables in the manuscript environment:

%% Option 1: If you sorted all figures and tables into the sections of the text, please also sort the appendix figures and appendix tables into the respective appendix sections.
%% They will be correctly named automatically.

%% Option 2: If you put all figures after the reference list, please insert appendix tables and figures after the normal tables and figures.
%% To rename them correctly to A1, A2, etc., please add the following commands in front of them:

\appendixfigures  %% needs to be added in front of appendix figures

\appendixtables   %% needs to be added in front of appendix tables

%% Please add \clearpage between each table and/or figure. Further guidelines on figures and tables can be found below.



\authorcontribution{TEXT} %% this section is mandatory

\competinginterests{TEXT} %% this section is mandatory even if you declare that no competing interests are present

\disclaimer{TEXT} %% optional section

\begin{acknowledgements}
TEXT
\end{acknowledgements}




%% REFERENCES

%% The reference list is compiled as follows:

%% \begin{thebibliography}{}
%% 
%% \bibitem[AUTHOR(YEAR)]{LABEL1}
%% REFERENCE 1
%% 
%% \bibitem[AUTHOR(YEAR)]{LABEL2}
%% REFERENCE 2
%% 
%% \end{thebibliography}

%% Since the Copernicus LaTeX package includes the BibTeX style file copernicus.bst,
%% authors experienced with BibTeX only have to include the following two lines:
%%
\bibliographystyle{copernicus}
\bibliography{schwarz_timeseries.bib}
%%
%% URLs and DOIs can be entered in your BibTeX file as:
%%
%% URL = {http://www.xyz.org/~jones/idx_g.htm}
%% DOI = {10.5194/xyz}


%% LITERATURE CITATIONS
%%
%% command                        & example result
%% \citet{jones90}|               & Jones et al. (1990)
%% \citep{jones90}|               & (Jones et al., 1990)
%% \citep{jones90,jones93}|       & (Jones et al., 1990, 1993)
%% \citep[p.~32]{jones90}|        & (Jones et al., 1990, p.~32)
%% \citep[e.g.,][]{jones90}|      & (e.g., Jones et al., 1990)
%% \citep[e.g.,][p.~32]{jones90}| & (e.g., Jones et al., 1990, p.~32)
%% \citeauthor{jones90}|          & Jones et al.
%% \citeyear{jones90}|            & 1990



%% FIGURES

%% When figures and tables are placed at the end of the MS (article in one-column style), please add \clearpage
%% between bibliography and first table and/or figure as well as between each table and/or figure.

% The figure files should be labelled correctly with Arabic numerals (e.g. fig01.jpg, fig02.png).


%% ONE-COLUMN FIGURES

%%f
%\begin{figure}[t]
%\includegraphics[width=8.3cm]{FILE NAME}
%\caption{TEXT}
%\end{figure}
%
%%% TWO-COLUMN FIGURES
%
%%f
%\begin{figure*}[t]
%\includegraphics[width=12cm]{FILE NAME}
%\caption{TEXT}
%\end{figure*}
%
%
%%% TABLES
%%%
%%% The different columns must be seperated with a & command and should
%%% end with \\ to identify the column brake.
%
%%% ONE-COLUMN TABLE
%
%%t
%\begin{table}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table}
%
%%% TWO-COLUMN TABLE
%
%%t
%\begin{table*}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table*}
%
%%% LANDSCAPE TABLE
%
%%t
%\begin{sidewaystable*}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{sidewaystable*}
%
%
%%% MATHEMATICAL EXPRESSIONS
%
%%% All papers typeset by Copernicus Publications follow the math typesetting regulations
%%% given by the IUPAC Green Book (IUPAC: Quantities, Units and Symbols in Physical Chemistry,
%%% 2nd Edn., Blackwell Science, available at: http://old.iupac.org/publications/books/gbook/green_book_2ed.pdf, 1993).
%%%
%%% Physical quantities/variables are typeset in italic font (t for time, T for Temperature)
%%% Indices which are not defined are typeset in italic font (x, y, z, a, b, c)
%%% Items/objects which are defined are typeset in roman font (Car A, Car B)
%%% Descriptions/specifications which are defined by itself are typeset in roman font (abs, rel, ref, tot, net, ice)
%%% Abbreviations from 2 letters are typeset in roman font (RH, LAI)
%%% Vectors are identified in bold italic font using \vec{x}
%%% Matrices are identified in bold roman font
%%% Multiplication signs are typeset using the LaTeX commands \times (for vector products, grids, and exponential notations) or \cdot
%%% The character * should not be applied as mutliplication sign
%
%
%%% EQUATIONS
%
%%% Single-row equation
%
%\begin{equation}
%
%\end{equation}
%
%%% Multiline equation
%
%\begin{align}
%& 3 + 5 = 8\\
%& 3 + 5 = 8\\
%& 3 + 5 = 8
%\end{align}
%
%
%%% MATRICES
%
%\begin{matrix}
%x & y & z\\
%x & y & z\\
%x & y & z\\
%\end{matrix}
%
%
%%% ALGORITHM
%
%\begin{algorithm}
%\caption{...}
%\label{a1}
%\begin{algorithmic}
%...
%\end{algorithmic}
%\end{algorithm}
%
%
%%% CHEMICAL FORMULAS AND REACTIONS
%
%%% For formulas embedded in the text, please use \chem{}
%
%%% The reaction environment creates labels including the letter R, i.e. (R1), (R2), etc.
%
%\begin{reaction}
%%% \rightarrow should be used for normal (one-way) chemical reactions
%%% \rightleftharpoons should be used for equilibria
%%% \leftrightarrow should be used for resonance structures
%\end{reaction}
%
%
%%% PHYSICAL UNITS
%%%
%%% Please use \unit{} and apply the exponential notation (e.g. 20\,\unit{W\,m^{-2}})


\end{document}
